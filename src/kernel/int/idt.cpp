#include <kernel/int/syscall.h>
#include <kernel/int/apic.h>
#include <kernel/int/idt.h>
#include <lib/asmUtils.h>
#include <lib/output.h>

idtEntry_t entries[256];
idtr_t idtr;

extern "C" void isrHandlerMain(regs_t *stack) {
    if(stack->isrNumber < 32) {
        uint64_t cr2;
        asm volatile ("cli\n" "mov %%cr2, %0" : "=a"(cr2));
        kprintDS("[KDEBUG]", "Congrats: you fucked up with a nice <%s> on core %d and error code %x, have fun debugging this", exceptionMessages[stack->isrNumber], stack->core, stack->errorCode);
        kprintDS("[KDEBUG]", "RAX: %a | RBX: %a | RCX: %a | RDX: %a", stack->rax, stack->rbx, stack->rcx, stack->rdx);
        kprintDS("[KDEBUG]", "RSI: %a | RDI: %a | RBP: %a | RSP: %a", stack->rsi, stack->rdi, stack->rbp, stack->rsp);
        kprintDS("[KDEBUG]", "r8:  %a | r9:  %a | r10: %a | r11: %a", stack->r8, stack->r9, stack->r10, stack->r11); 
        kprintDS("[KDEBUG]", "r12: %a | r13: %a | r14: %a | r15: %a", stack->r12, stack->r13, stack->r14, stack->r15); 
        kprintDS("[KDEBUG]", "cs:  %a | ss:  %a | cr2: %a | rip: %a", stack->cs, stack->ss, cr2, stack->rip); 
        for(;;); 
    }

    if(eventHandlers[stack->isrNumber] != NULL)
        eventHandlers[stack->isrNumber](stack);

    apic::lapicWrite(LAPIC_EOI, 0);
}

namespace idt {

void setEntry(uint16_t selector, uint8_t ist, uint8_t attributes, uint64_t offset, uint8_t index) {
    entries[index].offsetLow = (uint16_t)(offset >> 0);
    entries[index].selector = selector;
    entries[index].ist = ist;
    entries[index].attributes = attributes;
    entries[index].offsetMid = (uint16_t)(offset >> 16);
    entries[index].offsetHigh = (uint32_t)(offset >> 32);
    entries[index].zero = 0; 
}

void setIDTR() {
    idtr.limit = 256 * sizeof(idtEntry_t) - 1;
    idtr.offset = (uint64_t)&entries;
    asm volatile ("lidtq %0" : "=m"(idtr));
}

void init() {
    setEntry(0x8, 0, 0x8e, (uint64_t)isr0, 0);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr1, 1);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr2, 2);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr3, 3);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr4, 4);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr5, 5);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr6, 6);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr7, 7);
    setEntry(0x8, 0, 0x8e, (uint64_t)errorIsr8, 8);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr9, 9);
    setEntry(0x8, 0, 0x8e, (uint64_t)errorIsr10, 10);
    setEntry(0x8, 0, 0x8e, (uint64_t)errorIsr11, 11);
    setEntry(0x8, 0, 0x8e, (uint64_t)errorIsr12, 12);
    setEntry(0x8, 0, 0x8e, (uint64_t)errorIsr13, 13);
    setEntry(0x8, 0, 0x8e, (uint64_t)errorIsr14, 14);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr15, 15);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr16, 16);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr17, 17);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr18, 18);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr19, 19);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr20, 20);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr21, 21);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr22, 22);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr23, 23);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr24, 24);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr25, 25);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr26, 26);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr27, 27);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr28, 28);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr29, 29);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr30, 30);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr31, 31);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr32, 32);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr33, 33);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr34, 34);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr35, 35);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr36, 36);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr37, 37);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr38, 38);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr39, 39);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr40, 40);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr41, 41);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr42, 42);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr43, 43);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr44, 44);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr45, 45);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr46, 46);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr47, 47);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr48, 48);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr49, 49);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr50, 50);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr51, 51);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr52, 52);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr53, 53);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr54, 54);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr55, 55);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr56, 56);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr57, 57);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr58, 58);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr59, 59);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr60, 60);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr61, 61);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr62, 62);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr63, 63);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr64, 64);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr65, 65);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr66, 66);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr67, 67);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr68, 68);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr69, 69);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr70, 70);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr71, 71);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr72, 72);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr73, 73);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr74, 74);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr75, 75);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr76, 76);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr77, 77);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr78, 78);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr79, 79);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr80, 80);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr81, 81);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr82, 82);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr83, 83);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr84, 84);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr85, 85);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr86, 86);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr87, 87);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr88, 88);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr89, 89);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr90, 90);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr91, 91);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr92, 92);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr93, 93);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr94, 94);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr95, 95);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr96, 96);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr97, 97);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr98, 98);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr99, 99);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr100, 100);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr101, 101);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr102, 102);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr103, 103);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr104, 104);
    setEntry(0x8, 0, 0xee, (uint64_t)isr105, 105);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr106, 106);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr107, 107);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr108, 108);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr109, 109);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr110, 110);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr111, 111);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr112, 112);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr113, 113);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr114, 114);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr115, 115);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr116, 116);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr117, 117);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr118, 118);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr119, 119);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr120, 120);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr121, 121);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr122, 122);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr123, 123);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr124, 124);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr125, 125);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr126, 126);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr127, 127);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr128, 128);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr129, 129);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr130, 130);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr131, 131);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr132, 132);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr133, 133);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr134, 134);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr135, 135);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr136, 136);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr137, 137);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr138, 138);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr139, 139);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr140, 140);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr141, 141);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr142, 142);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr143, 143);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr144, 144);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr145, 145);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr146, 146);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr147, 147);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr148, 148);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr149, 149);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr150, 150);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr151, 151);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr152, 152);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr153, 153);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr154, 154);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr155, 155);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr156, 156);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr157, 157);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr158, 158);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr159, 159);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr160, 160);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr161, 161);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr162, 162);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr163, 163);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr164, 164);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr165, 165);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr166, 166);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr167, 167);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr168, 168);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr169, 169);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr170, 170);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr171, 171);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr172, 172);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr173, 173);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr174, 174);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr175, 175);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr176, 176);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr177, 177);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr178, 178);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr179, 179);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr180, 180);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr181, 181);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr182, 182);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr183, 183);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr184, 184);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr185, 185);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr186, 186);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr187, 187);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr188, 188);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr189, 189);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr190, 190);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr191, 191);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr192, 192);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr193, 193);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr194, 194);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr195, 195);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr196, 196);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr197, 197);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr198, 198);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr199, 199);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr200, 200);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr201, 201);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr202, 202);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr203, 203);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr204, 204);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr205, 205);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr206, 206);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr207, 207);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr208, 208);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr209, 209);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr210, 210);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr211, 211);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr212, 212);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr213, 213);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr214, 214);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr215, 215);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr216, 216);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr217, 217);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr218, 218);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr219, 219);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr220, 220);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr221, 221);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr222, 222);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr223, 223);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr224, 224);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr225, 225);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr226, 226);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr227, 227);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr228, 228);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr229, 229);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr230, 230);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr231, 231);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr232, 232);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr233, 233);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr234, 234);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr235, 235);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr236, 236);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr237, 237);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr238, 238);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr239, 239);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr240, 240);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr241, 241);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr242, 242);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr243, 243);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr244, 244);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr245, 245);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr246, 246);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr247, 247);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr248, 248);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr249, 249);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr250, 250);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr251, 251);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr252, 252);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr253, 253);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr254, 254);
    setEntry(0x8, 0, 0x8e, (uint64_t)isr255, 255);
}

}
